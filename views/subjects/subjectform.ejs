<%- include('../layouts/header') %>

<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-lg-12">
      <div class="card shadow-lg rounded-0">
        <div class="card-header bg-dark-subtle text-capitalize d-flex justify-content-between align-items-center">
          <h3><i class="fas fa-book me-2"></i>Subject Management</h3>
          <a class="btn btn-danger" href="/subjects/subject-form">Add New Subject</a>
        </div>
        <div class="card-body p-2 border">
          <% if (success) { %>
          <div class="alert alert-success alert-dismissible fade show" role="alert">
            <%= success %>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          <% } %>

          <% if (error) { %>
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <%= error %>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          <% } %>

          <div class="card-header mb-3 bg-danger text-light">
            <h5><%= subjectId ? 'Edit' : 'Create' %> Subject</h5>
          </div>
          <div class="row">
            <div class="col-md-6">
              <form action="/subjects/subject-form<%= subjectId ? '?subjectId=' + subjectId : '' %>" method="POST" class="border p-4 rounded bg-light">
                <div class="mb-3">
                  <label class="form-label">Subject Name</label>
                  <input type="text" name="name" class="form-control" value="<%= subjectData?.name || oldInput.name || '' %>" required />
                </div>
                <div class="row">
                  <div class="mb-3">
                    <label class="form-label">Full Marks</label>
                    <input type="text" name="fullmarks" class="form-control" value="<%= subjectData?.fullmarks || oldInput.fullmarks || '' %>" required />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Pass Marks</label>
                    <input type="text" name="passmarks" class="form-control" value="<%= subjectData?.passmarks || oldInput.passmarks || '' %>" required />
                  </div>
                </div>

                <div class="mb-3">
                  <label class="form-label">Classes</label>
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="checkAllClasses" onclick="toggleAllClasses(this)" />
                    <label class="form-check-label" for="checkAllClasses">Select All</label>
                  </div>

                  <div class="row">
                    <% listclass.forEach(cls => { %>
                    <div class="col-md-3 mb-3">
                      <div class="form-check">
                        <input class="form-check-input class-checkbox" type="checkbox" name="class_id[]" value="<%= cls.id %>" id="class_<%= cls.id %>" data-class-id="<%= cls.id %>" onchange="toggleSections(this)" <%= (subjectData?.subject_classes?.find(sc => sc.class_id == cls.id) || (oldInput.class_id && oldInput.class_id.includes(cls.id.toString()))) ? 'checked' : '' %> >
                        <label class="form-check-label" for="class_<%= cls.id %>">
                          <%= cls.class_name %>
                        </label>
                      </div>

                      <!-- Sections container for this class -->
                      <div id="sections_<%= cls.id %>" class="sections-container ms-4" style="display: none">
                        <% if (cls.sections && cls.sections.length > 0) { %>
                          <% cls.sections.forEach(section => { %>
                            <div class="form-check">
                              <input class="form-check-input section-checkbox" type="checkbox" name="section_mapping[]" value="<%= cls.id %>_<%= section.id %>" id="section_<%= cls.id %>_<%= section.id %>" />
                              <label class="form-check-label" for="section_<%= cls.id %>_<%= section.id %>">
                                <%= section.section_name %>
                              </label>
                            </div>
                          <% }) %>
                        <% } else { %>
                          <p class="text-muted small">No sections available</p>
                        <% } %>
                      </div>
                    </div>
                    <% }) %>
                  </div>
                </div>

                <button type="submit" class="btn btn-success btn-lg w-100"><%= subjectId ? 'Update' : 'Create' %> Subject</button>
              </form>
            </div>

            <% if (subjects && subjects.length > 0) { %>
            <div class="col-md-6">
              <table class="table table-bordered table-hover">
                <thead class="table-light">
                  <tr>
                    <th>S.N</th>
                    <th>Subject Name</th>
                    <th>Classes</th>
                    <th>Sections</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% subjects.forEach((subject, index) => { %>
                  <tr>
                    <td><%= index + 1 %></td>
                    <td><%= subject.name %></td>
                    <td>
                      <% if (subject.subject_classes && subject.subject_classes.length > 0) { %>
                        <% const uniqueClasses = new Set(); subject.subject_classes.forEach(sc => { if (sc.class) uniqueClasses.add(sc.class.class_name); }); %>
                        <% uniqueClasses.forEach(className => { %>
                          <%= className %><br />
                        <% }); %>
                      <% } %>
                    </td>
                    <td>
                      <% if (subject.subject_classes && subject.subject_classes.length > 0) { %>
                        <% const uniqueSections = new Set(); subject.subject_classes.forEach(sc => { if (sc.section) uniqueSections.add(sc.section.section_name); }); %>
                        <% uniqueSections.forEach(sectionName => { %>
                          <%= sectionName %><br />
                        <% }); %>
                      <% } else { %>
                        <i>No section assigned</i>
                      <% } %>
                    </td>
                    <td>
                      <a class="btn btn-outline-success fa fa-edit" href="/subjects/subject-form?subjectId=<%= subject.id %>" title="Edit Subject"></a>
                      <a class="btn btn-outline-danger fa fa-trash" onclick="return confirm('Are you sure you want to delete this subject?');" href="/subjects/delete-subjects/<%= subject.id %>" title="Delete Subject"></a>
                    </td>
                  </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
            <% } else { %>
            <div class="alert alert-info">No subjects available</div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%- include('../layouts/footer') %>
